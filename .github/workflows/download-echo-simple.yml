name: Download Echo APK

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Tag della release (lascia vuoto per latest)'
        required: false
  schedule:
    - cron: '0 0 * * *'  # Ogni giorno a mezzanotte

jobs:
  download:
    runs-on: ubuntu-latest
    
    steps:
      - name: Download and extract APK
        run: |
          # === CONFIGURAZIONE ===
          ECHO_OWNER="brahmkshatriya"     # Owner del repo
          ECHO_REPO="echo"          # Nome repo
          ZIP_NAME="artifact.zip" # Nome del file ZIP
          # ======================
          
#          # Determina il tag da scaricare
#          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
#            TAG="${{ github.event.inputs.release_tag }}"
#          else
#            TAG=$(curl -s https://api.github.com/repos/${ECHO_OWNER}/${ECHO_REPO}/workflows/nightly/main | jq -r '.tag_name')
#          fi
#          
          echo "üì• Downloading Echo ${TAG}..."
          
          # Costruisci URL e scarica
          URL="https://nightly.link/${ECHO_OWNER}/${ECHO_REPO}/workflows/nightly/main/${ZIP_NAME}"
          echo "URL: ${URL}"
          
          curl -L -o echo-release.zip "${URL}"
          
          # Estrai APK
          unzip -q echo-release.zip
          
          # Trova e rinomina APK
          APK=$(find . -name "*.apk" -type f | head -n 1)
          
          if [ -z "$APK" ]; then
            echo "‚ùå Errore: Nessun APK trovato!"
            exit 1
          fi
          
          mv "$APK" "echo-${TAG}.apk"
          
          echo "‚úÖ Download completato!"
          ls -lh echo-*.apk
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: echo-apk
          path: echo-*.apk
