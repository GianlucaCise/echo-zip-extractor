name: Download Echo APK with Version

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'

jobs:
  download_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install aapt (Android Asset Packaging Tool)
        run: |
          echo "ðŸ“¦ Installing aapt..."
          sudo apt-get update
          sudo apt-get install -y aapt
          aapt version
      
      - name: Download ed estrai APK
        run: |
          echo "ðŸ“¥ Downloading Echo APK from nightly.link..."
          
          curl -L -o echo-artifact.zip https://nightly.link/brahmkshatriya/echo/workflows/nightly/main/artifact.zip
          
          if [ ! -f echo-artifact.zip ]; then
            echo "âŒ Errore: Download fallito"
            exit 1
          fi
          
          FILE_SIZE=$(stat -c%s echo-artifact.zip 2>/dev/null || stat -f%z echo-artifact.zip 2>/dev/null)
          echo "Downloaded ${FILE_SIZE} bytes"
          
          if [ "$FILE_SIZE" -lt 1000 ]; then
            echo "âŒ Errore: File troppo piccolo"
            exit 1
          fi
          
          unzip -q echo-artifact.zip
          APK=$(find . -name "*.apk" -type f | head -n 1)
          
          if [ -z "$APK" ]; then
            echo "âŒ Errore: Nessun APK trovato"
            exit 1
          fi
          
          echo "âœ… APK trovato: ${APK}"
          cp "$APK" echo-temp.apk
      
      - name: Estrai informazioni versione dall'APK
        id: apk_info
        run: |
          echo "ðŸ” Estraendo informazioni dall'APK..."
          
          # Usa aapt per ottenere le info dall'APK
          APK_INFO=$(aapt dump badging echo-temp.apk)
          
          # Estrai versionName (es: "1.2.3")
          VERSION_NAME=$(echo "$APK_INFO" | grep "versionName" | sed -n "s/.*versionName='\([^']*\)'.*/\1/p")
          
          # Estrai versionCode (es: "123")
          VERSION_CODE=$(echo "$APK_INFO" | grep "versionCode" | sed -n "s/.*versionCode='\([^']*\)'.*/\1/p")
          
          # Estrai package name
          PACKAGE_NAME=$(echo "$APK_INFO" | grep "package:" | sed -n "s/.*name='\([^']*\)'.*/\1/p")
          
          # Estrai minSdkVersion e targetSdkVersion
          MIN_SDK=$(echo "$APK_INFO" | grep "sdkVersion" | sed -n "s/.*sdkVersion:'\([^']*\)'.*/\1/p")
          TARGET_SDK=$(echo "$APK_INFO" | grep "targetSdkVersion" | sed -n "s/.*targetSdkVersion:'\([^']*\)'.*/\1/p")
          
          echo "ðŸ“± Informazioni APK:"
          echo "  - Version Name: ${VERSION_NAME}"
          echo "  - Version Code: ${VERSION_CODE}"
          echo "  - Package: ${PACKAGE_NAME}"
          echo "  - Min SDK: ${MIN_SDK}"
          echo "  - Target SDK: ${TARGET_SDK}"
          
          # Salva negli output
          echo "version_name=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "version_code=${VERSION_CODE}" >> $GITHUB_OUTPUT
          echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
          echo "min_sdk=${MIN_SDK}" >> $GITHUB_OUTPUT
          echo "target_sdk=${TARGET_SDK}" >> $GITHUB_OUTPUT
          
          # Crea il tag della release usando la versione
          DATE=$(date +%d-%m-%Y_%H-%M)
          
          # Se la versione esiste, usala nel tag
          if [ -n "$VERSION_NAME" ]; then
            RELEASE_TAG="v${VERSION_NAME}"
            echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
            echo "release_name=Echo ${VERSION_NAME}" >> $GITHUB_OUTPUT
          else
            # Fallback al formato data
            RELEASE_TAG="${DATE}"
            echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
            echo "release_name=Echo Build ${DATE}" >> $GITHUB_OUTPUT
          fi
          
          echo "ðŸ·ï¸ Release tag: ${RELEASE_TAG}"
      
      - name: Rinomina APK con versione
        run: |
          VERSION="${{ steps.apk_info.outputs.version_name }}"
          
          if [ -n "$VERSION" ]; then
            cp echo-temp.apk "echo-${VERSION}.apk"
            echo "âœ… APK rinominato in: echo-${VERSION}.apk"
          else
            DATE=$(date +%d-%m-%Y_%H-%M)
            cp echo-temp.apk "echo-${DATE}.apk"
            echo "âœ… APK rinominato in: echo-${DATE}.apk"
          fi
          
          cp echo-temp.apk echo-latest.apk
          
          ls -lh echo-*.apk
      
      - name: Calcola checksums
        id: checksums
        run: |
          APK_SIZE=$(stat -c%s echo-latest.apk 2>/dev/null || stat -f%z echo-latest.apk 2>/dev/null)
          APK_SIZE_MB=$(awk "BEGIN {printf \"%.2f\", $APK_SIZE / 1024 / 1024}")
          echo "apk_size_mb=${APK_SIZE_MB}" >> $GITHUB_OUTPUT
          
          MD5_HASH=$(md5sum echo-latest.apk | cut -d' ' -f1)
          SHA256_HASH=$(sha256sum echo-latest.apk | cut -d' ' -f1)
          echo "md5_hash=${MD5_HASH}" >> $GITHUB_OUTPUT
          echo "sha256_hash=${SHA256_HASH}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Checksums:"
          echo "  MD5: ${MD5_HASH}"
          echo "  SHA256: ${SHA256_HASH}"
          echo "  Size: ${APK_SIZE_MB} MB"
      
      - name: Check if version already released
        id: check_existing
        continue-on-error: true
        run: |
          TAG="${{ steps.apk_info.outputs.release_tag }}"
          
          # Controlla se il tag esiste giÃ 
          if git ls-remote --tags origin | grep -q "refs/tags/${TAG}"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Release ${TAG} giÃ  esistente"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Nuova versione: ${TAG}"
          fi
      
      - name: Get Echo repository info
        id: echo_info
        continue-on-error: true
        run: |
          ECHO_INFO=$(curl -s https://api.github.com/repos/brahmkshatriya/echo)
          ECHO_STARS=$(echo "$ECHO_INFO" | jq -r '.stargazers_count')
          ECHO_DESC=$(echo "$ECHO_INFO" | jq -r '.description')
          
          echo "echo_stars=${ECHO_STARS}" >> $GITHUB_OUTPUT
          echo "echo_desc=${ECHO_DESC}" >> $GITHUB_OUTPUT
          
          LAST_COMMIT=$(curl -s https://api.github.com/repos/brahmkshatriya/echo/commits/main)
          COMMIT_MSG=$(echo "$LAST_COMMIT" | jq -r '.commit.message' | head -n 1)
          COMMIT_SHA=$(echo "$LAST_COMMIT" | jq -r '.sha' | cut -c1-7)
          COMMIT_DATE=$(echo "$LAST_COMMIT" | jq -r '.commit.author.date')
          
          echo "commit_msg=${COMMIT_MSG}" >> $GITHUB_OUTPUT
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "commit_date=${COMMIT_DATE}" >> $GITHUB_OUTPUT
      
      - name: Create version info file
        run: |
          {
            echo "Echo APK Version Information"
            echo "============================"
            echo ""
            echo "Version Name: ${{ steps.apk_info.outputs.version_name }}"
            echo "Version Code: ${{ steps.apk_info.outputs.version_code }}"
            echo "Package Name: ${{ steps.apk_info.outputs.package_name }}"
            echo ""
            echo "Android Requirements:"
            echo "- Minimum SDK: ${{ steps.apk_info.outputs.min_sdk }}"
            echo "- Target SDK: ${{ steps.apk_info.outputs.target_sdk }}"
            echo ""
            echo "File Information:"
            echo "- Size: ${{ steps.checksums.outputs.apk_size_mb }} MB"
            echo "- MD5: ${{ steps.checksums.outputs.md5_hash }}"
            echo "- SHA256: ${{ steps.checksums.outputs.sha256_hash }}"
            echo ""
            echo "Build Information:"
            echo "- Download Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "- Echo Commit: ${{ steps.echo_info.outputs.commit_sha }}"
            echo "- Commit Message: ${{ steps.echo_info.outputs.commit_msg }}"
          } > VERSION_INFO.txt
          
          cat VERSION_INFO.txt
      
      - name: Create Release
        if: steps.check_existing.outputs.exists != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.apk_info.outputs.release_tag }}
          name: ${{ steps.apk_info.outputs.release_name }}
          body: |
            ## ðŸ“¦ Echo APK - Version ${{ steps.apk_info.outputs.version_name }}
            
            > **Note**: This repository is not affiliated with the official Echo project.
            
            ### ðŸ“± APK Information
            - **Version Name:** `${{ steps.apk_info.outputs.version_name }}`
            - **Version Code:** `${{ steps.apk_info.outputs.version_code }}`
            - **Package Name:** `${{ steps.apk_info.outputs.package_name }}`
            - **Size:** ${{ steps.checksums.outputs.apk_size_mb }} MB
            
            ### ðŸ“‹ Android Requirements
            - **Minimum SDK:** API ${{ steps.apk_info.outputs.min_sdk }}
            - **Target SDK:** API ${{ steps.apk_info.outputs.target_sdk }}
            
            ### ðŸ” Checksums
            ```
            MD5:    ${{ steps.checksums.outputs.md5_hash }}
            SHA256: ${{ steps.checksums.outputs.sha256_hash }}
            ```
            
            ### ðŸ“ Latest Echo Commit
            - **Commit:** [`${{ steps.echo_info.outputs.commit_sha }}`](https://github.com/brahmkshatriya/echo/commit/${{ steps.echo_info.outputs.commit_sha }})
            - **Message:** ${{ steps.echo_info.outputs.commit_msg }}
            - **Date:** ${{ steps.echo_info.outputs.commit_date }}
            
            ### ðŸ”— Links
            - ðŸŒŸ [Echo Repository](https://github.com/brahmkshatriya/echo) (${{ steps.echo_info.outputs.echo_stars }} stars)
            - ðŸ“¥ [Nightly Link Source](https://nightly.link/brahmkshatriya/echo/workflows/nightly/main/artifact.zip)
            
            ### ðŸ“„ Files
            - `echo-${{ steps.apk_info.outputs.version_name }}.apk` - Main APK file
            - `echo-latest.apk` - Symlink to the latest version
            - `VERSION_INFO.txt` - Detailed version information
            
            ---
            
            **Description:** ${{ steps.echo_info.outputs.echo_desc }}
          draft: false
          prerelease: false
          files: |
            echo-${{ steps.apk_info.outputs.version_name }}.apk
            echo-latest.apk
            VERSION_INFO.txt
      
      - name: Skip release (version exists)
        if: steps.check_existing.outputs.exists == 'true'
        run: |
          echo "â­ï¸ Release ${{ steps.apk_info.outputs.release_tag }} giÃ  esistente"
          echo "â„¹ï¸ Nessuna nuova release creata"
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± APK Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.apk_info.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Code:** ${{ steps.apk_info.outputs.version_code }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Package:** ${{ steps.apk_info.outputs.package_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Size:** ${{ steps.checksums.outputs.apk_size_mb }} MB" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ·ï¸ Release" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.apk_info.outputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Already Exists:** ${{ steps.check_existing.outputs.exists }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Latest Release](https://github.com/${{ github.repository }}/releases/latest)" >> $GITHUB_STEP_SUMMARY
          echo "- [All Releases](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
